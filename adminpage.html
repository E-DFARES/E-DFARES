<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Admin Page</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    
    <link rel="stylesheet" href="pagestyles.css">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>
</head>

<body class="bg-gray-100">
    <header class="headertop bg-blue-900 text-white p-5">
        <div class="containerhh mx-auto flex justify-between items-center">
            <h1 class="text-2xl font-bold"> <i class="fa-solid fa-user-tie"></i> Admin - <span id="admin-name2"></span></h1>

            <nav>
                <ul class="flex space-x-4">
                <li><a href="index.html" class="hover:underline"><i class="fa-solid fa-house"></i> Home</a></li>
                </ul>
            </nav>
        </div>
    </header>
<footer class="footerbtm bg-blue-900 text-white p-6">
    <p>&copy; 2024. All rights reserved.</p>
</footer>

    <div class="flex h-screen">
        
        <div class="sidebar">
            <button id="showProfile" data-specific-id="aprofile"><i class="fa-regular fa-user"></i> Profile</button>
            <button id="showProductList" data-specific-id="aproduct"><i class="fa-solid fa-laptop"></i> Product</button>
            <button id="showReportList" data-specific-id="areport"><i class="fa-regular fa-flag"></i> Report</button>
            <button id="showOrderList" data-specific-id="aorder"><i class="fa-regular fa-clipboard"></i> Request</button>
            <button id="showFeedback" data-specific-id="afeedback"><i class="fa-regular fa-comment"></i> Feedback</button>
            <button id="showContactus" data-specific-id="acontact"><i class="fa-solid fa-phone"></i> Contact Us</button>
            <button id="showUsermanual" data-specific-id="amanual"><i class="fa-regular fa-file-lines"></i> User Manual</button>
            <hr>
            <button id="registerUserBtn">Register User</button>
            <button id="registerTechBtn">Register Technician</button>
            <hr>
            <button id="signoutbutton">Sign Out <i class="fa-solid fa-right-from-bracket"></i></button>
        </div>

        <script>
            // Function to store a specific ID in localStorage
            function storeButtonClick(event) {
                const specificId = event.currentTarget.getAttribute('data-specific-id');
                localStorage.setItem('AdminlastClickedButton', specificId);
                console.log(`Stored ${specificId} in localStorage`);
            }
    
            // Function to add event listeners to buttons
            function addClickListeners() {
                const buttons = document.querySelectorAll('button[data-specific-id]');
                buttons.forEach(button => {
                    button.addEventListener('click', storeButtonClick);
                });
            }
    
            // Function to click the button that matches the specific ID in localStorage
            function clickLastButton() {
                const AdminlastClickedButtonId = localStorage.getItem('AdminlastClickedButton');
                if (AdminlastClickedButtonId) {
                    const AdminlastClickedButton = document.querySelector(`button[data-specific-id="${AdminlastClickedButtonId}"]`);
                    if (AdminlastClickedButton) {
                        AdminlastClickedButton.click();
                        console.log(`Clicked button with data-specific-id ${AdminlastClickedButtonId} from localStorage`);
                    }
                }
            }
    
            // Add event listeners when the DOM content is loaded
            document.addEventListener('DOMContentLoaded', () => {
                addClickListeners();
                clickLastButton();
            });
        </script>


        
        <div class="flex-1 p-6">
            <h2 class="technician text-2xl font-bold mb-4"><span id=""></span></h2>

      <!-- Profile -->
      <div id="profileListContainer" class="hidden container">
        <h2 class="title"><i class="fa-regular fa-user"></i> Profile</h2>
        <div id="infoContainer" class="info-container">
            
            <p id="user-uid" class="text-lg font-semibold text-gray-700"></p>
            <button id="copyuidBtn" class="text-lg font-semibold text-gray-700">Copy Admin ID</button>
            <p id="admin-name" class="text-lg font-semibold text-gray-700"></p>
            <p id="admin-ic" class="text-lg font-semibold text-gray-700"></p>
            <p id="admin-phonenumber" class="text-lg font-semibold text-gray-700"></p>
            <p id="admin-address" class="text-lg font-semibold text-gray-700"></p>
            <p id="admin-email" class="text-lg font-semibold text-gray-700"></p>
        </div>
        <br>
        <button id="OpenPdfBtn" class="pdfBtn">Open In Pdf</button>
    </div>

    <script>
        document.getElementById("OpenPdfBtn").addEventListener("click", function () {
            // Get all buttons and hide them
            var buttons = document.querySelectorAll('button');
            buttons.forEach(button => button.style.display = 'none');
            
            // Get the content of the container
            var element = document.getElementById("infoContainer");
        
            // Use html2pdf to convert the content to PDF
            html2pdf().from(element).set({
                margin: 10,
                filename: 'Profile.pdf',
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, logging: true, dpi: 192, letterRendering: true },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            }).save().then(function() {
                // Show all buttons again after the PDF is generated
                buttons.forEach(button => button.style.display = 'inline-block');
            });
        });
    </script>


        


    <!-- Product List -->
    <div id="productListContainer" class="container mx-auto hidden">
      <h2 class="title text-3xl font-bold text-gray-900 mb-6"><i class="fa-solid fa-laptop"></i> Products</h2>
      <div id="productInfoContainer" class="info-container bg-white shadow-md rounded-lg p-6">
            <input type="text" id="productInp" placeholder="Enter product name" class="w-full px-4 py-2 mb-4 border border-gray-300 rounded-md focus:outline-none focus:border-blue-500">
            <input type="text" id="serialInp" placeholder="Enter product serial number" class="w-full px-4 py-2 mb-4 border border-gray-300 rounded-md focus:outline-none focus:border-blue-500">
            <button id="productBtn">Add Product</button>  
            <div id="tablecontainer">
                <table class="table">
                  <thead>
                      <tr>
                          <th class="col-product">Product</th>
                          <th class="col-serial">Serial Number</th>
                          <th class="col-date">Date</th>
                          <th class="col-delete"></th>
                      </tr>
                  </thead>
                  <tbody id="productTableBody">
                  </tbody>
                </table>
            </div>
            <button id="OpenPdfBtn2" class="pdfBtn">Open In Pdf</button>
      </div>
    </div>

    <script>
        document.getElementById("OpenPdfBtn2").addEventListener("click", function () {
            // Get all buttons and hide them
            var buttons = document.querySelectorAll('button');
            buttons.forEach(button => button.style.display = 'none');
            
            // Get the content of the container
            var element = document.getElementById("tablecontainer");
        
            // Use html2pdf to convert the content to PDF
            html2pdf().from(element).set({
                margin: 10,
                filename: 'Product.pdf',
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, logging: true, dpi: 192, letterRendering: true },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            }).save().then(function() {
                // Show all buttons again after the PDF is generated
                buttons.forEach(button => button.style.display = 'inline-block');
            });
        });
    </script>

    <!-- Report List -->
    <div id="treportListContainer" class="hidden container">
      <h2 class="title"><i class="fa-regular fa-flag"></i> Report List</h2>
      <div id="infoContainer" class="info-container"></div>
      
      <div id="reporttablecontainer">
          <table class="table">
              <thead>
                  <tr>
                      <th class="col-tuserfullname">User Name</th>
                      <th class="col-tproduct">Product</th>
                      <th class="col-tserialnumber">Serial Number</th>
                      <th class="col-treport">Report</th>
                      <th class="col-tdate">Date</th>
                      <th class="col-treport">Technician Feedback</th>
                  </tr>
              </thead>
              <tbody id="reportTableBody">
              </tbody>
          </table>
      </div>
      <br>
      <button id="OpenPdfBtn3" class="pdfBtn">Open In Pdf</button>
  </div>

  <script>
    document.getElementById("OpenPdfBtn3").addEventListener("click", function () {
        // Get all buttons and hide them
        var buttons = document.querySelectorAll('button');
        buttons.forEach(button => button.style.display = 'none');
        
        // Get the content of the container
        var element = document.getElementById("reporttablecontainer");
    
        // Use html2pdf to convert the content to PDF
        html2pdf().from(element).set({
            margin: 10,
            filename: 'report.pdf',
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { scale: 2, logging: true, dpi: 192, letterRendering: true },
            jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
        }).save().then(function() {
            // Show all buttons again after the PDF is generated
            buttons.forEach(button => button.style.display = 'inline-block');
        });
    });
</script>

  <!-- Request List -->
  <div id="orderListContainer" class="hidden container">
    <h2 class="title"><i class="fa-regular fa-clipboard"></i> Request</h2>
    <div id="infoContainer" class="info-container"></div>
    
    <div id="ordertablecontainer">
        <table class="table">
            <thead>
                <tr>
                    <th class="col-userfullname">User Name</th>
                    <th class="col-product">Product</th>
                    <th class="col-status">Status</th>
                    <th class="col-approve"></th>
                    <th class="col-reject"></th>
                    <th></th>
                </tr>
            </thead>
            <tbody id="orderTableBody">
                
                <thead>
                    <tr>
                        <th class="col-userfullname"></th>
                        <th class="col-product"></th>
                        <th class="col-approval"></th>
                        <th class="col-Deleteorder"></th>
                        <th></th>
                        <th></th>
                    </tr>
                </thead>
                <tbody id="approvedTableBody"></tbody>
                <tbody id="rejectedTableBody"></tbody>
            </tbody>
        </table>
    </div>
    <button id="OpenPdfBtn4" class="pdfBtn">Open In Pdf</button>
  </div>

  <script>
    document.getElementById("OpenPdfBtn4").addEventListener("click", function () {
        // Get all buttons and hide them
        var buttons = document.querySelectorAll('button');
        buttons.forEach(button => button.style.display = 'none');
        
        // Get the content of the container
        var element = document.getElementById("ordertablecontainer");
    
        // Use html2pdf to convert the content to PDF
        html2pdf().from(element).set({
            margin: 10,
            filename: 'Request.pdf',
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { scale: 2, logging: true, dpi: 192, letterRendering: true },
            jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
        }).save().then(function() {
            // Show all buttons again after the PDF is generated
            buttons.forEach(button => button.style.display = 'inline-block');
        });
    });
</script>

    <!-- Chat -->
    <div id="feedbackContainer" class="hidden container">
        <h2 class="title"><i class="fa-regular fa-comment"></i> Feedback</h2>
        <div id="infoContainer" class="info-container"></div>
        <div class="input-container">
            <div id="chatContainer" class="chat-container"></div>
            <input type="text" id="chatInput" placeholder="Type your message...">
            <button id="sendButton">Send</button>
        </div>
    </div>

<!-- Contact Us -->
<div id="contactusContainer" class="hidden container">
    <h2 class="title"><i class="fa-solid fa-phone"></i> Contact Us</h2>
    <div id="infoContainer" class="info-container">
        <h3>Customer Support</h3>
        <p>If you have any questions or need assistance, please feel free to reach out to our customer support team. We are here to help you with any issues or concerns you may have.</p>
        
        <h3>Contact Information</h3>
        <ul>
            <li><strong>Email:</strong> ecomres@gmail.com</li>
            <li><strong>Phone:</strong> 07-133 4278</li>
            <li><strong>Address:</strong> Kolej Kemahiran Johor, Jalan Jumaat, Kampung Ungku Mohsin, 80350 Johor Bahru, Johor</li>
        </ul>
        
        <h3>Business Hours</h3>
        <p>Our support team is available during the following hours:</p>
        <ul>
            <li><strong>Sunday - Wednesday:</strong> 9:00 AM - 6:00 PM</li>
            <li><strong>Thursday:</strong> 10:00 AM - 4:00 PM</li>
            <li><strong>Friday & Saturday:</strong> Closed</li>
        </ul>
        
        <h3>Follow Us</h3>
        <p>Stay connected and follow us on social media for the latest updates and news:</p>
        <ul>
            <li><strong>Facebook:</strong> <a href="https://www.facebook.com/ecomres" target="_blank">facebook.com/ecomres</a></li>
            <li><strong>Twitter:</strong> <a href="https://www.twitter.com/ecomres" target="_blank">twitter.com/ecomres</a></li>
            <li><strong>LinkedIn:</strong> <a href="https://www.linkedin.com/company/ecomres" target="_blank">linkedin.com/company/ecomres</a></li>
        </ul>
    </div>
</div>

  <div id="usermanualContainer" class="hidden container">
    <h2 class="title"><i class="fa-regular fa-file-lines"></i> User Manual</h2>
    <div id="infoContainer" class="info-container">
        <div class="step">
            <ul>
                <li><b>Register Users and Technicians</b></li>
                <li>Admin can register new user and technician accounts.</li>
                <br>
                <li><b>Add Product</b></li>
                <li>Admin can add a product by entering its serial number.</li>
                <br>
                <li><b>View Reports</b></li>
                <li>Admin can view reports made by users.</li>
                <br>
                <li><b>Approve Request</b></li>
                <li>Admin needs to approve Request, which will then be sent to technicians for processing.</li>
            </ul>
        </div>
    </div>
</div>






  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.1/firebase-app.js";
    import { getDatabase, set, onValue, get, ref, child, remove, push } from "https://www.gstatic.com/firebasejs/10.12.1/firebase-database.js";
    import { getAuth } from "https://www.gstatic.com/firebasejs/10.12.1/firebase-auth.js";

    // For Firebase JS SDK v7.20.0 and later, measurementId is optional
    const firebaseConfig = {
        apiKey: "AIzaSyCi54RIsuF-w0-baut0GZ1yNyoMg5VsNMw",
        authDomain: "e-dfares.firebaseapp.com",
        databaseURL: "https://e-dfares-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "e-dfares",
        storageBucket: "e-dfares.appspot.com",
        messagingSenderId: "172364723669",
        appId: "1:172364723669:web:90b88766d4ef37fffb395c",
        measurementId: "G-H28TTTD19M"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);
    const dbref = ref(db);

    // Retrieve admin UID from localStorage
    const adminUid = localStorage.getItem("admin-uid");
    let userFullName; 


    // Function to handle product submission
    document.getElementById("productBtn").addEventListener("click", () => {
        const productName = document.getElementById("productInp").value.trim();
        const productSerial = document.getElementById("serialInp").value.trim();

        if (productName !== "" && productSerial !== "") {
            // Push product data to the database under admin UID
            const productsRef = ref(db, `AdminsAuthList/${adminUid}/products`);
            const newProductRef = push(productsRef);
            const productData = {
                name: productName,
                serial: productSerial,
                date: new Date().toLocaleDateString(), // Capture the current date
            };
            set(newProductRef, productData)
                .then(() => {
                    // Clear input fields after submission
                    document.getElementById("productInp").value = "";
                    document.getElementById("serialInp").value = "";

                    // Create element to display product
                    const productRow = document.createElement("tr");
                    productRow.innerHTML = `
                        <td>${productData.name}</td>
                        <td>${productData.serial}</td>
                        <td>${productData.date}</td>
                    `;
                })
                .catch((error) => {
                    console.error("Error adding product: ", error);
                });
        } else {
            alert("Please enter both a product name and a serial number.");
        }
    });


    // Fetch and display products under admin UID with delete button
    function fetchAndDisplayProducts() {
        const adminProductsRef = ref(db, `AdminsAuthList/${adminUid}/products`);

        onValue(adminProductsRef, (snapshot) => {
            const productTableBody = document.getElementById("productTableBody");
            productTableBody.innerHTML = ''; // Clear the table before adding updated data

            if (snapshot.exists()) {
                snapshot.forEach((childSnapshot) => {
                    const productData = childSnapshot.val();
                    const productId = childSnapshot.key;
                    const productRow = document.createElement("tr");
                    productRow.setAttribute('data-id', productId);
                    productRow.innerHTML = `
                        <td>${productData.name}</td>
                        <td>${productData.serial}</td>
                        <td>${productData.date}</td>
                        <td style="text-align: center;">
                            <button class="delete-btn"><i class="fa-solid fa-trash-can"></i></button>
                        </td>
                    `;
                    productTableBody.appendChild(productRow);
                });
            } else {
                console.log("No products available for this admin.");
            }
        }, (error) => {
            console.error("Error retrieving products: ", error);
        });
    }

    // Handle delete button click
    document.getElementById("productTableBody").addEventListener("click", (event) => {
        if (event.target.classList.contains("delete-btn") || event.target.closest(".delete-btn")) {
            const productRow = event.target.closest("tr");
            handleDeleteProduct(productRow);
        }
    });

    function handleDeleteProduct(productRow) {
        const productId = productRow.dataset.id;
        const productRef = ref(db, `AdminsAuthList/${adminUid}/products/${productId}`);

        remove(productRef)
            .then(() => {
                productRow.remove();
                console.log("Product deleted successfully");
            })
            .catch((error) => {
                console.error("Error deleting product: ", error);
            });
    }

    document.addEventListener("DOMContentLoaded", (event) => {
        fetchAndDisplayProducts();
    });







    // Fetch and display reports with real-time updates
    function fetchReports() {
    const adminUid = localStorage.getItem("admin-uid");
    if (!adminUid) {
        console.log("Admin UID not found");
        return;
    }

    const reportsRef = ref(db, `AdminsAuthList/${adminUid}/reports`);

    onValue(reportsRef, (snapshot) => {
        const reportTableBody = document.getElementById("reportTableBody");
        reportTableBody.innerHTML = ''; // Clear the table before adding updated data

        if (snapshot.exists()) {
            const reportsData = snapshot.val();
            const reportsArray = Object.keys(reportsData).map(reportId => ({
                id: reportId,
                ...reportsData[reportId]
            }));

            // Reverse the array to get the opposite order
            reportsArray.reverse();

            // Create table rows for each report in the reversed array
            reportsArray.forEach(report => {
                const row = document.createElement("tr");

                const userFullNameCell = document.createElement("td");
                userFullNameCell.textContent = report.userFullName || "-";
                row.appendChild(userFullNameCell);

                const productCell = document.createElement("td");
                productCell.textContent = report.product || "-";
                row.appendChild(productCell);

                const serialNumberCell = document.createElement("td");
                serialNumberCell.textContent = report.serial || "-";
                row.appendChild(serialNumberCell);

                const reportCell = document.createElement("td");
                reportCell.textContent = report.report || "-";
                row.appendChild(reportCell);

                const dateCell = document.createElement("td");
                dateCell.textContent = report.date || "-";
                row.appendChild(dateCell);

                const editedTextCell = document.createElement("td");
                editedTextCell.textContent = report.editedText || "-";
                row.appendChild(editedTextCell);

                reportTableBody.appendChild(row);
            });
        } else {
            console.log("No data available");
        }
    }, (error) => {
        console.error("Error fetching reports:", error);
    });
    }

    fetchReports();


    

    

    // Function to fetch and display Request with real-time updates
    function fetchAndDisplayOrders() {
        const ordersRef = ref(db, `AdminsAuthList/${adminUid}/orders`);
        
        onValue(ordersRef, (snapshot) => {
            const orderTableBody = document.getElementById("orderTableBody");
            orderTableBody.innerHTML = ''; // Clear the table before adding updated data

            if (snapshot.exists()) {
                snapshot.forEach((childSnapshot) => {
                    const orderData = childSnapshot.val();
                    const orderId = childSnapshot.key;
                    const orderRow = document.createElement("tr");
                    orderRow.setAttribute('data-id', orderId);
                    orderRow.innerHTML = `
                        <td>${orderData.userFullName}</td>
                        <td>${orderData.product}</td>
                        <td style="text-align: center;">Pending</td>
                        <td>
                            <button class="approve-btn">Approve</button>
                        </td>
                        <td>
                            <button class="reject-btn">Reject</button>
                        </td>
                        <td>
                        </td>
                    `;
                    orderTableBody.appendChild(orderRow);
                });
            } else {
                console.log("No Request available for this admin.");
            }
        }, (error) => {
            console.error("Error retrieving Request: ", error);
        });
    }

    fetchAndDisplayOrders();



    // Retrieve admin UID from localStorage
    const admincUid = localStorage.getItem("user-admin-uid");
    let useruFullName;

    if (!admincUid) {
        console.error("Admin UID not found in localStorage");
    } else {
        getAdminInfo(admincUid);
    }

    // Function to fetch and display approved Request with real-time updates
    function fetchAndDisplayApprovedOrders() {
        const ordersRef = ref(db, `AdminsAuthList/${admincUid}/approved`);

        onValue(ordersRef, (snapshot) => {
            const approvedTableBody = document.getElementById("approvedTableBody");
            approvedTableBody.innerHTML = ''; // Clear the table before adding updated data

            if (snapshot.exists()) {
                snapshot.forEach((childSnapshot) => {
                    const orderData = childSnapshot.val();
                    const orderId = childSnapshot.key;
                    const orderRow = document.createElement("tr");
                    orderRow.setAttribute('data-id', orderId);
                    orderRow.innerHTML = `
                        <td>${orderData.userFullName}</td>
                        <td>${orderData.product}</td>
                        <td style="text-align: center; color: green;">Approved</td>
                        <td></td>
                        <td></td>
                        <td style="text-align: center;">
                            <button class="delete-btn"><i class="fa-solid fa-trash-can"></i></button>
                        </td>
                    `;
                    approvedTableBody.appendChild(orderRow);
                });
                addDeleteEventListeners();
            } else {
                console.log("No approved Request available for this admin.");
            }
        }, (error) => {
            console.error("Error retrieving approved Request: ", error);
        });
    }

    // Function to fetch and display rejected Request with real-time updates
    function fetchAndDisplayRejectedOrders() {
        const ordersRef = ref(db, `AdminsAuthList/${admincUid}/rejected`);

        onValue(ordersRef, (snapshot) => {
            const rejectedTableBody = document.getElementById("rejectedTableBody");
            rejectedTableBody.innerHTML = ''; // Clear the table before adding updated data

            if (snapshot.exists()) {
                snapshot.forEach((childSnapshot) => {
                    const orderData = childSnapshot.val();
                    const orderId = childSnapshot.key;
                    const orderRow = document.createElement("tr");
                    orderRow.setAttribute('data-id', orderId);
                    orderRow.innerHTML = `
                        <td>${orderData.userFullName}</td>
                        <td>${orderData.product}</td>
                        <td style="text-align: center; color: red;">Rejected</td>
                        <td></td>
                        <td></td>
                        <td style="text-align: center;">
                        <button class="delete-btn"><i class="fa-solid fa-trash-can"></i></button>
                        </td>
                    `;
                    rejectedTableBody.appendChild(orderRow);
                });
                addDeleteEventListeners();
            } else {
                console.log("No rejected Request available for this admin.");
            }
        }, (error) => {
            console.error("Error retrieving rejected Request: ", error);
        });
    }

    // Function to add event listeners to delete buttons
    function addDeleteEventListeners() {
        const deleteButtons = document.querySelectorAll(".delete-btn");
        deleteButtons.forEach(button => {
            button.addEventListener("click", (event) => {
                const orderRow = event.target.closest("tr");
                const orderId = orderRow.getAttribute('data-id');
                const orderStatus = orderRow.cells[2].innerText.toLowerCase(); // 'approved' or 'rejected'
                deleteOrder(orderId, orderStatus, orderRow);
            });
        });
    }

    // Function to delete an order
    function deleteOrder(orderId, orderStatus, orderRow) {
        const orderRef = ref(db, `AdminsAuthList/${admincUid}/${orderStatus}/${orderId}`);
        remove(orderRef)
            .then(() => {
                console.log(`Order ${orderId} deleted successfully`);
                orderRow.remove();
            })
            .catch((error) => {
                console.error("Error deleting order: ", error);
            });
    }

    fetchAndDisplayApprovedOrders();
    fetchAndDisplayRejectedOrders();




    document.getElementById("orderListContainer").addEventListener("click", (event) => {
        if (event.target.classList.contains("approve-btn")) {
            const orderRow = event.target.closest("tr");
            handleApprove(orderRow);
        } else if (event.target.classList.contains("reject-btn")) {
            const orderRow = event.target.closest("tr");
            handleReject(orderRow);
        }
    });

    

    // Approve button function -------------------------------------
    function handleApprove(orderRow) {
        const orderData = getOrderData(orderRow, 'approved');
        const approvedRef = ref(db, `AdminsAuthList/${adminUid}/approved`);
        const newApprovedRef = push(approvedRef);
        set(newApprovedRef, orderData).then(() => {
            remove(ref(db, `AdminsAuthList/${adminUid}/orders/${orderData.id}`));
            orderRow.remove();
            console.log("Order approved and moved to approved list");
        }).catch((error) => {
            console.error("Error approving order: ", error);
        });
    }
    // Approve button function -------------------------------------



    function handleReject(orderRow) {
        const orderData = getOrderData(orderRow, 'rejected');
        const rejectedRef = ref(db, `AdminsAuthList/${adminUid}/rejected`);
        const newRejectedRef = push(rejectedRef);
        set(newRejectedRef, orderData).then(() => {
            remove(ref(db, `AdminsAuthList/${adminUid}/orders/${orderData.id}`));
            orderRow.remove();
            console.log("Order rejected and moved to rejected list");
        }).catch((error) => {
            console.error("Error rejecting order: ", error);
        });
    }

    function getOrderData(orderRow, status) {
        return {
            id: orderRow.dataset.id,
            userFullName: orderRow.cells[0].textContent,
            product: orderRow.cells[1].textContent,
            status: status
        };
    }

  
    document.addEventListener('DOMContentLoaded', () => {
        const adminInfo = JSON.parse(localStorage.getItem('admin-info'));
        const adminCreds = JSON.parse(localStorage.getItem('admin-creds'));

        if (adminInfo && adminCreds) {
            const uid = adminCreds.uid;
            const adminICNumber = adminInfo.adminicnumber;
            const adminFullName = adminInfo.adminfullname;
            const adminPhoneNumber = adminInfo.adminphonenumber;
            const adminemail = adminCreds.email;
            const adminAddress = adminInfo.adminaddress;

            // Display the admin information below each other
            document.getElementById('user-uid').textContent = `${uid}`;
            document.getElementById('admin-ic').textContent = `Ic: ${adminICNumber}`;
            document.getElementById('admin-phonenumber').textContent = `Phone Number: ${adminPhoneNumber}`;
            document.getElementById('admin-address').textContent = `Address: ${adminAddress}`;
            document.getElementById('admin-name').textContent = `Name: ${adminFullName}`;
            document.getElementById('admin-name2').textContent = ` ${adminFullName}`;
            document.getElementById('admin-email').textContent = `Email: ${adminemail}`;


            document.getElementById('sendButton').addEventListener('click', () => {
            const chatInput = document.getElementById('chatInput').value;
            if (chatInput.trim() !== '') {
                const chatRef = ref(db, `AdminsAuthList/${uid}/Chat`);
                push(chatRef, {
                    message: chatInput,
                    chatName: adminFullName,
                    timestamp: Date.now()
                }).then(() => {
                    document.getElementById('chatInput').value = ''; // Clear input field after sending
                    console.log('Message sent successfully');
                    setTimeout(scrollToBottom, 100); // Auto-scroll to bottom after sending
                }).catch((error) => {
                    console.error('Error sending message:', error);
                });
            }
        });

        const chatContainer = document.getElementById('chatContainer');
        const chatRef = ref(db, `AdminsAuthList/${uid}/Chat`);

        // Function to create delete button for each chat message
        function createDeleteButton(messageId) {
            const deleteButton = document.createElement('button');
            deleteButton.classList.add('delete-button');
            const trashIcon = document.createElement('i');
            trashIcon.classList.add('fas', 'fa-trash-can');
            deleteButton.appendChild(trashIcon);
            deleteButton.addEventListener('click', () => {
                // Call function to delete message by its ID
                deleteMessage(messageId);
            });
            return deleteButton;
        }

        // Function to delete a message by its ID
        function deleteMessage(messageId) {
            const messageRef = ref(db, `AdminsAuthList/${adminUid}/Chat/${messageId}`);
            remove(messageRef)
                .then(() => {
                    console.log('Message deleted successfully');
                })
                .catch((error) => {
                    console.error('Error deleting message:', error);
                });
        }

        // Update chat rendering function to include delete button
        onValue(chatRef, (snapshot) => {
            const messages = snapshot.val();
            chatContainer.innerHTML = ''; // Clear previous chat messages
            for (const messageId in messages) {
                const messageData = messages[messageId];
                const chatDiv = document.createElement('div');
                const chatTextarea = document.createElement('textarea');
                chatTextarea.classList.add('chat-textarea');
                chatTextarea.readOnly = true;
                chatTextarea.value = `${messageData.chatName}: ${messageData.message}`;
                const deleteButton = createDeleteButton(messageId);
                chatDiv.appendChild(chatTextarea);
                chatDiv.appendChild(deleteButton);
                chatContainer.appendChild(chatDiv);
            }
        });

        function scrollToBottom() {
            window.scrollTo(0, document.body.scrollHeight);
        }
                

            // Save UID in localStorage
            localStorage.setItem('admin-uid', uid);

            // Example logic to determine if user information is found
            const userInformationFound = true; // Set this based on your actual logic

            if (userInformationFound) {
                // Add event listener to the button
                document.getElementById('registerTechBtn').addEventListener('click', () => {
                    // Show a confirmation dialog
                    const userConfirmed = confirm('Are you sure you want to register a new technician?');

                    // If the user clicks "OK", redirect to the registration page
                    if (userConfirmed) {
                        window.location.href = 'registertech.html';
                    }
                });
            } else {
                alert('Information not found. Please log in again.');
                window.location.href = 'loginadmin.html';
            }

            // Add event listener to the button
            document.getElementById('registerUserBtn').addEventListener('click', () => {
            // Show a confirmation dialog
            const userConfirmed = confirm('open register user page?');
            
            // If the user clicks "OK", redirect to the registration page
            if (userConfirmed) {
                window.location.href = 'registeruser.html';
            }
        });
        } else {
            alert('information not found. Please log in again.');
            window.location.href = 'loginadmin.html';
        }
    });


    function getAdminInfo(adminUid) {
        const adminRef = ref(db, `AdminsAuthList/${adminUid}`);
        get(child(adminRef, 'adminicnumber')).then((snapshot) => {
            if (snapshot.exists()) {
                const adminICNumber = snapshot.val();
                // Save admin's IC number in local storage
                localStorage.setItem("admin-icnumber", adminICNumber);
                return adminICNumber;
            } else {
                console.log("No data available");
                return null;
            }
        });
    }

    


    if (!adminUid) {
        console.error("Admin UID not found in localStorage");
    }

    // Check if admin UID exists in localStorage
    if (adminUid) {
        // Call the function to get admin info
        getAdminInfo(adminUid);
    } else {
        console.log("Admin UID not found in localStorage");
    }



    document.getElementById("showProfile").addEventListener("click", () => {
        document.getElementById("profileListContainer").classList.remove("hidden");
        document.getElementById("treportListContainer").classList.add("hidden");
        document.getElementById("orderListContainer").classList.add("hidden");
        document.getElementById("feedbackContainer").classList.add("hidden");
        document.getElementById("contactusContainer").classList.add("hidden");
        document.getElementById("usermanualContainer").classList.add("hidden");
        document.getElementById("productListContainer").classList.add("hidden");
    });

    document.getElementById("showReportList").addEventListener("click", () => {
        document.getElementById("treportListContainer").classList.remove("hidden");
        document.getElementById("profileListContainer").classList.add("hidden");
        document.getElementById("orderListContainer").classList.add("hidden");
        document.getElementById("feedbackContainer").classList.add("hidden");
        document.getElementById("contactusContainer").classList.add("hidden");
        document.getElementById("usermanualContainer").classList.add("hidden");
        document.getElementById("productListContainer").classList.add("hidden");

        // Fetch reports when the Report List button is clicked
        fetchReports();
    });

    document.getElementById("showOrderList").addEventListener("click", () => {
        document.getElementById("orderListContainer").classList.remove("hidden");
        document.getElementById("profileListContainer").classList.add("hidden");
        document.getElementById("treportListContainer").classList.add("hidden");
        document.getElementById("feedbackContainer").classList.add("hidden");
        document.getElementById("contactusContainer").classList.add("hidden");
        document.getElementById("usermanualContainer").classList.add("hidden");
        document.getElementById("productListContainer").classList.add("hidden");
    });

    
    document.getElementById("showFeedback").addEventListener("click", () => {
        document.getElementById("feedbackContainer").classList.remove("hidden");
        document.getElementById("profileListContainer").classList.add("hidden");
        document.getElementById("treportListContainer").classList.add("hidden");
        document.getElementById("orderListContainer").classList.add("hidden");
        document.getElementById("contactusContainer").classList.add("hidden");
        document.getElementById("usermanualContainer").classList.add("hidden");
        document.getElementById("productListContainer").classList.add("hidden");
    });

    document.getElementById("showContactus").addEventListener("click", () => {
        document.getElementById("contactusContainer").classList.remove("hidden");
        document.getElementById("profileListContainer").classList.add("hidden");
        document.getElementById("treportListContainer").classList.add("hidden");
        document.getElementById("orderListContainer").classList.add("hidden");
        document.getElementById("feedbackContainer").classList.add("hidden");
        document.getElementById("usermanualContainer").classList.add("hidden");
        document.getElementById("productListContainer").classList.add("hidden");
    });

    document.getElementById("showUsermanual").addEventListener("click", () => {
        document.getElementById("usermanualContainer").classList.remove("hidden");
        document.getElementById("profileListContainer").classList.add("hidden");
        document.getElementById("treportListContainer").classList.add("hidden");
        document.getElementById("orderListContainer").classList.add("hidden");
        document.getElementById("feedbackContainer").classList.add("hidden");
        document.getElementById("contactusContainer").classList.add("hidden");
        document.getElementById("productListContainer").classList.add("hidden");
    });

    document.getElementById("showProductList").addEventListener("click", () => {
        document.getElementById("productListContainer").classList.remove("hidden");
        document.getElementById("profileListContainer").classList.add("hidden");
        document.getElementById("treportListContainer").classList.add("hidden");
        document.getElementById("orderListContainer").classList.add("hidden");
        document.getElementById("feedbackContainer").classList.add("hidden");
        document.getElementById("contactusContainer").classList.add("hidden");
        document.getElementById("usermanualContainer").classList.add("hidden");
    });

    document.getElementById("copyuidBtn").addEventListener("click", () => {
    const uidElement = document.getElementById("user-uid");
    const uid = uidElement.textContent;

    // Copy UID to clipboard
    navigator.clipboard.writeText(uid).then(() => {
        alert("Admin ID copied to clipboard");
    }).catch((error) => {
        console.error("Error copying text: ", error);
    });

    // Store UID in local storage
    localStorage.setItem("adminUID", uid);
});

    // Function sign out
    document.getElementById("signoutbutton").addEventListener("click", () => {
        // Clear specific items from localStorage
        localStorage.removeItem("admin-uid");
        localStorage.removeItem("admin-info");
        localStorage.removeItem("admin-creds");
        localStorage.removeItem("admin-icnumber");
        localStorage.removeItem("AdminlastClickedButton");
        
        // Redirect to login page
        window.location.href = "loginadmin.html";
    });
  </script>
  
</body>

</html>
